worldTimeZones = {
  "ACDT (Australian Central Daylight Savings Time)": 37800,
  "ACST (Australian Central Standard Time)": 34200,
  "ACT (Acre Time)": -18000,
  "ADT (Atlantic Daylight Time)": -10800,
  "AEDT (Australian Eastern Daylight Savings Time)": 39600,
  "AEST (Australian Eastern Standard Time)": 36000,
  "AFT (Afghanistan Time)": 16200,
  "AKDT (Alaska Daylight Time)": -28800,
  "AKST (Alaska Standard Time)": -32400,
  "AMST (Amazon Summer Time (Brazil)[1])": -10800,
  "AMT (Amazon Time (Brazil)[2])": -14400,
  "AMT (Armenia Time)": 14400,
  "ART (Argentina Time)": -10800,
  "AST (Arabia Standard Time)": 10800,
  "AST (Atlantic Standard Time)": -14400,
  "AWST (Australian Western Standard Time)": 28800,
  "AZOST (Azores Summer Time)": 0,
  "AZOT (Azores Standard Time)": -3600,
  "AZT (Azerbaijan Time)": 14400,
  "BDT (Brunei Time)": 28800,
  "BIOT (British Indian Ocean Time)": 21600,
  "BIT (Baker Island Time)": -43200,
  "BOT (Bolivia Time)": -14400,
  "BRST (Brasilia Summer Time)": -7200,
  "BRT (Brasilia Time)": -10800,
  "BST (Bangladesh Standard Time)": 21600,
  "BST (Bougainville Standard Time[3])": 39600,
  "BST (British Summer Time (British Standard Time from Feb 1968 to Oct 1971))": 3600,
  "BTT (Bhutan Time)": 21600,
  "CAT (Central Africa Time)": 7200,
  "CCT (Cocos Islands Time)": 23400,
  "CDT (Central Daylight Time (North America))": -18000,
  "CDT (Cuba Daylight Time[4])": -14400,
  "CEST (Central European Summer Time (Cf. HAEC))": 7200,
  "CET (Central European Time)": 3600,
  "CHADT (Chatham Daylight Time)": 48600,
  "CHAST (Chatham Standard Time)": 45000,
  "CHOT (Choibalsan Standard Time)": 28800,
  "CHOST (Choibalsan Summer Time)": 32400,
  "CHST (Chamorro Standard Time)": 36000,
  "CHUT (Chuuk Time)": 36000,
  "CIST (Clipperton Island Standard Time)": -28800,
  "CIT (Central Indonesia Time)": 28800,
  "CKT (Cook Island Time)": -36000,
  "CLST (Chile Summer Time)": -10800,
  "CLT (Chile Standard Time)": -14400,
  "COST (Colombia Summer Time)": -14400,
  "COT (Colombia Time)": -18000,
  "CST (Central Standard Time (North America))": -21600,
  "CST (China Standard Time)": 28800,
  "ACST (Central Standard Time (Australia))": 34200,
  "ACDT (Central Summer Time (Australia))": 37800,
  "CST (Cuba Standard Time)": -18000,
  "CT (China time)": 28800,
  "CVT (Cape Verde Time)": -3600,
  "CWST (Central Western Standard Time (Australia) unofficial)": 30600,
  "CXT (Christmas Island Time)": 25200,
  "DAVT (Davis Time)": 25200,
  "DDUT (Dumont d'Urville Time)": 36000,
  "DFT (AIX specific equivalent of Central European Time[5])": 3600,
  "EASST (Easter Island Summer Time)": -18000,
  "EAST (Easter Island Standard Time)": -21600,
  "EAT (East Africa Time)": 10800,
  "ECT (Eastern Caribbean Time (does not recognise DST))": -14400,
  "ECT (Ecuador Time)": -18000,
  "EDT (Eastern Daylight Time (North America))": -14400,
  "AEDT (Eastern Summer Time (Australia))": 39600,
  "EEST (Eastern European Summer Time)": 10800,
  "EET (Eastern European Time)": 7200,
  "EGST (Eastern Greenland Summer Time)": 0,
  "EGT (Eastern Greenland Time)": -3600,
  "EIT (Eastern Indonesian Time)": 32400,
  "EST (Eastern Standard Time (North America))": -18000,
  "AEST (Eastern Standard Time (Australia))": 36000,
  "FET (Further-eastern European Time)": 10800,
  "FJT (Fiji Time)": 43200,
  "FKST (Falkland Islands Summer Time)": -10800,
  "FKT (Falkland Islands Time)": -14400,
  "FNT (Fernando de Noronha Time)": -7200,
  "GALT (Galapagos Time)": -21600,
  "GAMT (Gambier Islands)": -32400,
  "GET (Georgia Standard Time)": 14400,
  "GFT (French Guiana Time)": -10800,
  "GILT (Gilbert Island Time)": 43200,
  "GIT (Gambier Island Time)": -32400,
  "GMT (Greenwich Mean Time)": 0,
  "GST (South Georgia and the South Sandwich Islands)": -7200,
  "GST (Gulf Standard Time)": 14400,
  "GYT (Guyana Time)": -14400,
  "HADT (Hawaii-Aleutian Daylight Time)": -32400,
  "HAEC (Heure Avanc\u00e9e d'Europe Centrale francised name for CEST)": 7200,
  "HAST (Hawaii-Aleutian Standard Time)": -36000,
  "HKT (Hong Kong Time)": 28800,
  "HMT (Heard and McDonald Islands Time)": 18000,
  "HOVST (Khovd Summer Time)": 28800,
  "HOVT (Khovd Standard Time)": 25200,
  "ICT (Indochina Time)": 25200,
  "IDT (Israel Daylight Time)": 10800,
  "IOT (Indian Ocean Time)": 10800,
  "IRDT (Iran Daylight Time)": 16200,
  "IRKT (Irkutsk Time)": 28800,
  "IRST (Iran Standard Time)": 12600,
  "IST (Indian Standard Time)": 19800,
  "IST (Irish Standard Time[6])": 3600,
  "IST (Israel Standard Time)": 7200,
  "JST (Japan Standard Time)": 32400,
  "KGT (Kyrgyzstan time)": 21600,
  "KOST (Kosrae Time)": 39600,
  "KRAT (Krasnoyarsk Time)": 25200,
  "KST (Korea Standard Time)": 32400,
  "LHST (Lord Howe Standard Time)": 37800,
  "LHST (Lord Howe Summer Time)": 39600,
  "LINT (Line Islands Time)": 50400,
  "MAGT (Magadan Time)": 43200,
  "MART (Marquesas Islands Time)": -34200,
  "MAWT (Mawson Station Time)": 18000,
  "MDT (Mountain Daylight Time (North America))": -21600,
  "MET (Middle European Time Same zone as CET)": 3600,
  "MEST (Middle European Summer Time Same zone as CEST)": 7200,
  "MHT (Marshall Islands)": 43200,
  "MIST (Macquarie Island Station Time)": 39600,
  "MIT (Marquesas Islands Time)": -34200,
  "MMT (Myanmar Standard Time)": 23400,
  "MSK (Moscow Time)": 10800,
  "MST (Malaysia Standard Time)": 28800,
  "MST (Mountain Standard Time (North America))": -25200,
  "MUT (Mauritius Time)": 14400,
  "MVT (Maldives Time)": 18000,
  "MYT (Malaysia Time)": 28800,
  "NCT (New Caledonia Time)": 39600,
  "NDT (Newfoundland Daylight Time)": -9000,
  "NFT (Norfolk Time)": 39600,
  "NPT (Nepal Time)": 19800,
  "NST (Newfoundland Standard Time)": -12600,
  "NT (Newfoundland Time)": -12600,
  "NUT (Niue Time)": -39600,
  "NZDT (New Zealand Daylight Time)": 46800,
  "NZST (New Zealand Standard Time)": 43200,
  "OMST (Omsk Time)": 21600,
  "ORAT (Oral Time)": 18000,
  "PDT (Pacific Daylight Time (North America))": -25200,
  "PET (Peru Time)": -18000,
  "PETT (Kamchatka Time)": 43200,
  "PGT (Papua New Guinea Time)": 36000,
  "PHOT (Phoenix Island Time)": 46800,
  "PHT (Philippine Time)": 28800,
  "PKT (Pakistan Standard Time)": 18000,
  "PMDT (Saint Pierre and Miquelon Daylight time)": -7200,
  "PMST (Saint Pierre and Miquelon Standard Time)": -10800,
  "PONT (Pohnpei Standard Time)": 39600,
  "PST (Pacific Standard Time (North America))": -28800,
  "PST (Philippine Standard Time)": 28800,
  "PYST (Paraguay Summer Time (South America)[7])": -10800,
  "PYT (Paraguay Time (South America)[8])": -14400,
  "RET (R\u00e9union Time)": 14400,
  "ROTT (Rothera Research Station Time)": -10800,
  "SAKT (Sakhalin Island time)": 39600,
  "SAMT (Samara Time)": 14400,
  "SAST (South African Standard Time)": 7200,
  "SBT (Solomon Islands Time)": 39600,
  "SCT (Seychelles Time)": 14400,
  "SGT (Singapore Time)": 28800,
  "SLST (Sri Lanka Standard Time)": 19800,
  "SRET (Srednekolymsk Time)": 39600,
  "SRT (Suriname Time)": -10800,
  "SST (Samoa Standard Time)": -39600,
  "SST (Singapore Standard Time)": 28800,
  "SYOT (Showa Station Time)": 10800,
  "TAHT (Tahiti Time)": -36000,
  "THA (Thailand Standard Time)": 25200,
  "TFT (Indian/Kerguelen)": 18000,
  "TJT (Tajikistan Time)": 18000,
  "TKT (Tokelau Time)": 46800,
  "TLT (Timor Leste Time)": 32400,
  "TMT (Turkmenistan Time)": 18000,
  "TRT (Turkey Time)": 10800,
  "TOT (Tonga Time)": 46800,
  "TVT (Tuvalu Time)": 43200,
  "ULAST (Ulaanbaatar Summer Time)": 32400,
  "ULAT (Ulaanbaatar Standard Time)": 28800,
  "USZ1 (Kaliningrad Time)": 7200,
  "UYST (Uruguay Summer Time)": -7200,
  "UYT (Uruguay Standard Time)": -10800,
  "UZT (Uzbekistan Time)": 18000,
  "VET (Venezuelan Standard Time)": -14400,
  "VLAT (Vladivostok Time)": 36000,
  "VOLT (Volgograd Time)": 14400,
  "VOST (Vostok Station Time)": 21600,
  "VUT (Vanuatu Time)": 39600,
  "WAKT (Wake Island Time)": 43200,
  "WAST (West Africa Summer Time)": 7200,
  "WAT (West Africa Time)": 3600,
  "WEST (Western European Summer Time)": 3600,
  "WET (Western European Time)": 0,
  "WIT (Western Indonesian Time)": 25200,
  "WST (Western Standard Time)": 28800,
  "YAKT (Yakutsk Time)": 32400,
  "YEKT (Yekaterinburg Time)": 18000
}

var menuItem = {
  id: "timeExtension",
  title: "Convert Time",
  contexts: ["selection"],
};
chrome.contextMenus.create(menuItem);

let pattern = /([0-9]+)\:([0-9]*)(PM|AM)?$/;

function isTime(value) {
  return pattern.test(value);
}

function isNull(value) {
  return value == null || value == "" || value == undefined;
}

function convertTimezone(value) {
  var time = pattern.exec(value);
  var hour = time[1], minute = time[2], type = time[3];
  var currDate = new Date();
  var dateString = `${currDate.toDateString()} ${hour}:${minute} ${isNull(type) ? " " : type}`;
  var date = new Date(dateString)

  // convert timezones
  var finalDate = new Date(date.getTime() + (- userSavedTimezoneFrom + userSavedTimezoneTo) * 1000)

  return `${finalDate.getHours()}:${finalDate.getMinutes()}`;
}

var userSavedTimezoneFrom, userSavedTimezoneTo;

function chromeNotification(message) {
  var notifOptions = {
    priority: 1,
    type: "basic",
    iconUrl: "icon.png",
    title: "Converted Time",
    message: message,
    silent: true
  };
  chrome.notifications.create(notifOptions);
}

// Get the selected timezones
chrome.storage.sync.get(["timezoneFrom", "timezoneTo"], (zone) => {
  userSavedTimezoneFrom = worldTimeZones[zone.timezoneFrom];
  userSavedTimezoneTo = worldTimeZones[zone.timezoneTo];
});

chrome.storage.onChanged.addListener(function(){
  chrome.storage.sync.get(["timezoneFrom", "timezoneTo"], (zone) => {
    userSavedTimezoneFrom = worldTimeZones[zone.timezoneFrom];
    userSavedTimezoneTo = worldTimeZones[zone.timezoneTo];
  });
});

// onclicklistner for time convert option selector
chrome.contextMenus.onClicked.addListener(function (clickData) {
  if (
    clickData.menuItemId == "timeExtension" &&
    isTime(clickData.selectionText)
  ) {
    var message;
    chrome.storage.sync.get(["timezoneFrom", "timezoneTo"], (zone) => {
      var userSavedTimezoneFrom = zone.timezoneFrom;
      var userSavedTimezoneTo = zone.timezoneTo;

      if (isNull(userSavedTimezoneFrom) || isNull(userSavedTimezoneTo)) {
        message = "Select the timezones in extension popup!!";
      } 
      else {
        message = convertTimezone(clickData.selectionText);
      }
      chromeNotification(message);
    });
  }
  else {
    chromeNotification("Select valid time!!");
  }
});
